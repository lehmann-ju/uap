# This configuration repeats the analysis published in:
# Targeted sequencing for gene discovery and quantification using RNA CaptureSeq,
# Mercer et al., Nature Protocols, 2014

################################################################################
## Cluster Section                                                            ##
## ===============                                                            ##
##                                                                            ##
## - uncomment/adapt as required                                              ##
################################################################################

# cluster:
#     # example for SLURM grid engine
#     default_submit_options: "--cpus-per-task=#{CORES} --ntasks=1"
#     # example for UGE/SGE respectively OGS
#     default_submit_options: "-pe smp #{CORES} -cwd -S /bin/bash -l h_rt=24:00:00 -l h_vmem=6G"
#     default_pre_job_command: "echo 'Run Started!'"
#     default_post_job_command: "echo 'Run Finished!'"
#     default_job_quota: 5

################################################################################
## Destination Path Section                                                   ##
## ========================                                                   ##
##                                                                            ##
## - directory where analysis results get stored                              ##
################################################################################

destination_path: /data/bioinf/projects/data/2020_Singularity_testing/testlehmanju

################################################################################
## Constants Section                                                          ##
## =================                                                          ##
##                                                                            ##
## - define constants for later use here                                      ##
################################################################################

constants:
    # 1.  Genome Information:
    # 1.1 Complete Sequence (FASTA)
    - &genome
        "/data/db/ebi/pub/databases/gencode/Gencode_human/release_29/GRCh38.primary_assembly.genome/2019-04-08/GRCh38.primary_assembly.genome.fa"

    # 1.2 FASTA index
    - &genome_faidx 
        "/data/galaxy_server/galaxy/tool-data/hg38_gencode29/sam_indexes/hg38_gencode29/GRCh38.primary_assembly.genome.fa.fai"

    # 2.  Mapping Indices:
    # 2.1 Hisat2 index
    - &ht2-idx
        "/data/galaxy_server/galaxy/tool-data/hg38_gencode29/hisat2_index/hg38_gencode29/hg38_gencode29"

    # 2.2 Segemehl
 #   - &segemehl_genome_index
 #       genomes/animalia/chordata/mammalia/primates/homo_sapiens/hg19/hg19_segemehl_index/segemehl_index-hg19_all_chr_UCSC-all_sequences-dbEMdEVV/segemehl_index-hg19_all_chr_UCSC-all_sequences.idx

    # 3.  Gencode Annotation:
    # 3.1 Version 24
    - &gencode_v19_annotation_gtf
        "/data/db/ebi/pub/databases/gencode/Gencode_human/release_29/gencode.v29/2018-11-07/gencode.v29.primary_assembly.annotation.gtf"

################################################################################
## Steps Section                                                              ##
## =============                                                              ##
##                                                                            ##
## - define analysis steps here                                               ##
################################################################################

steps:
    #################
    ## Source step ##
    #################
    fastq_source:
        sample_to_files_map:
            capture_RNA:
                - example-out/2014-Mercer_et_al_download/SRR1032214_1_download/download/SRR1032214_1.fastq
                - example-out/2014-Mercer_et_al_download/SRR1032214_2_download/download/SRR1032214_2.fastq
        paired_end: yes
        first_read: _1.fastq
        second_read: _2.fastq
        
    fastqc:
      _depends: fastq_source

    fastx_quality_stats:
      _depends: fastq_source

    hisat2:
        _depends: fastq_source
        _cluster_submit_options: "-pe smp 4 -cwd -S /bin/bash -l h_rt=168:00:00 -l h_vmem=8G"
        index: *ht2-idx
        cores: 4
        library_type: "fr"
        rna-strandness: "RF"
        dta: true
#         _singularity_container: '/gloabl/apps/uap/uap.sif' #while using a seperated singularity container for this step, set the path for the singularity container

    sort_hisat2_by_pos (sam_to_sorted_bam):
        _depends: hisat2
        sort-by-name: no
        genome-faidx: *genome_faidx
        temp-sort-dir: '/tmp/'

    count_genes_hisat2 (htseq_count):
        _depends: sort_hisat2_by_pos
        feature-file: *gencode_v19_annotation_gtf
        order: pos
        stranded: 'yes'
        mode: intersection-strict
        type: exon
        idattr: gene_id

    cufflinks_hisat2 (cufflinks):
        _depends: sort_hisat2_by_pos
        library-type: fr-secondstrand
        mask-file: *gencode_v19_annotation_gtf
        
    segemehl_index (segemehl_generate_index):
        _depends: *genome
        _connect: 
            in/reference_sequence: human_genome/raw
        index-basename: humane_genome_index

# Uncomment the following steps if you created the segemehl genome index
    segemehl:
        _depends: fastq_source
        genome: human_genome
        index: human_genome_index

    s2c:
        _depends: segemehl
        tmp_dir: /tmp/

    sort_segemehl_by_pos (sam_to_sorted_bam):
        _depends: s2c
        sort-by-name: no
        genome-faidx: *genome_faidx
        temp-sort-dir: /tmp/

    count_genes_segemehl (htseq_count):
        _depends: sort_segemehl_by_pos
        feature-file: *gencode_v19_annotation_gtf
        order: pos
        stranded: 'yes'
        mode: intersection-strict
        type: exon
        idattr: gene_id

    cufflinks_segemehl (cufflinks):
        _depends: sort_segemehl_by_pos
        library-type: fr-secondstrand
        mask-file: *gencode_v19_annotation_gtf

################################################################################
## Tools Section                                                              ##
## =============                                                              ##
##                                                                            ##
## - define used tools here                                                   ##
## - for module system usage see documentation                                ##
################################################################################

tools:
    ##################
    # External Tools #
    ##################

    # URL: http://cufflinks.cbcb.umd.edu/
    cufflinks:
        path: cufflinks
        get_version: --version
        exit_code: 1

    # URL: http://www.bioinformatics.babraham.ac.uk/projects/fastqc/
    fastqc:
        path: fastqc
        get_version: --version
        exit_code: 0

    # URL: http://www-huber.embl.de/users/anders/HTSeq/doc/count.html
    htseq-count:
        path: htseq-count
        get_version: -h
        exit_code: 0

    # URL: http://zlib.net/pigz/
    pigz:
        path: pigz
        get_version: --version
        exit_code: 0

    # URL: http://www.htslib.org/
    # NOTE: uap requires samtools version 1.0 or greater
    samtools:
        path: samtools
        get_version: '--version'
        exit_code: 0

    # URL: http://www.bioinf.uni-leipzig.de/Software/segemehl/
    segemehl: 
        path: segemehl.x
        get_version: ''
        exit_code: 255

    # URL: http://daehwankimlab.github.io/hisat2/
    hisat2:
        path: hisat2
        get_version: --version
        exit_code: 0

    # URL: http://hannonlab.cshl.edu/fastx_toolkit/
    fastx_quality_stats:
        path: fastx_quality_stats
        get_version: -h
        exit_code: 1


    ##############
    # Unix Tools #
    ##############

    tar:
        path: 'tar'
        get_version: '--version'
        exit_code: 0
